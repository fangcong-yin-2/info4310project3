<html>

<head>
    <title>INFO 4310 Project 2</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <!-- Load d3-cloud -->
    <script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>

</head>

<body>
    <div class="word_cloud">
        <svg id="cloud" height="400" width="500"></svg>
        <script>
            const request_data = async function (sl_year) {
                const yelp = await d3.csv("yelp_pittsburgh.csv", d3.autoType);
                var myWords = [{
                    word: "Running",
                    size: "10"
                }, {
                    word: "Surfing",
                    size: "20"
                }, {
                    word: "Climbing",
                    size: "40"
                }, {
                    word: "Kiting",
                    size: "30"
                }, {
                    word: "Sailing",
                    size: "20"
                }, {
                    word: "Snowboarding",
                    size: "50"
                }]

                let canvas = d3.select("svg#cloud");
                // set the dimensions and margins of the graph
                const margin = {
                    top: 10,
                    right: 10,
                    bottom: 10,
                    left: 10
                };
                const width = canvas.attr('width') - margin.left - margin.right;
                const height = canvas.attr('height') - margin.top - margin.bottom;
                let snippets = [];

                yelp.forEach((d, i) => {
                    snippets[i] = d['snippet'];
                })
                snp = snippets[4];

                let words = snp.replaceAll('\n', ' ').split(' ');
                console.log(words);
                let word_freq = {};
                words.forEach(d => {
                    if (word_freq[d] === undefined) {
                        word_freq[d] = 1;
                    } else {
                        word_freq[d] += 1;

                    }

                });

                let fontExtent = d3.extent(Object.values(word_freq));
                const minFont = 10;
                const maxFont = 50;
                let fontScale = d3.scaleLinear().domain(fontExtent).range([minFont, maxFont]);
                // append the svg object to the body of the page
                let svg = canvas
                    .append("g")
                    .attr("transform",
                        "translate(" + margin.left + "," + margin.top + ")");

                // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
                // Wordcloud features that are different from one word to the other must be here
                var layout = d3.layout.cloud()
                    .size([width, height])
                    .words(Object.keys(word_freq).map(function (d) {
                        return {
                            text: d,
                            size: fontScale(word_freq[d])
                        };
                    }))
                    .padding(5) //space between words
                    .rotate(function () {
                        return ~~(Math.random() * 2) * 90;
                    })
                    .fontSize(function (d) {
                        return d.size;
                    }) // font size of words
                    .on("end", draw);
                layout.start();

                // This function takes the output of 'layout' above and draw the words
                // Wordcloud features that are THE SAME from one word to the other can be here
                function draw(words) {
                    svg
                        .append("g")
                        .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                        .selectAll("text")
                        .data(words)
                        .enter().append("text")
                        .style("font-size", function (d) {
                            return d.size;
                        })
                        .style("fill", "#69b3a2")
                        .attr("text-anchor", "middle")
                        .style("font-family", "Impact")
                        .attr("transform", function (d) {
                            return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                        })
                        .text(function (d) {
                            return d.text;
                        });
                }
            }
            request_data();
        </script>
    </div>


    <div class="activities">
        <div class = "types">
            <button id="all">All Types</button>
            <button id="food">Food</button>
            <button id="arts">Art</button>
            <button id="nightlife">Night Life</button>
            <button id="active">Active</button>
            <button id="shopping">Shopping</button>
        </div>
        <div class = "food_types">
            <div class = "cuisine"></div>
            <div class = "food_type"></div>

        </div>
        
    </div>

    <div id='chloropleth'>
        <svg id="map" height="700" width="700"></svg>

        <script>
            const svg = d3.select("#map");
            const width_map = svg.attr("width");
            const height_map = svg.attr("height");
            const margin = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            };
            const mapWidth = width_map - margin.left - margin.right;
            const mapHeight = height_map - margin.top - margin.bottom;
            const map = svg.append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                let button_already = false;
                let clicked_food = false;
                let clicked_cuisine = false;
                let clicked_type = false;
                let dropButton_cuisine;


                let dropButton_type;

            const request_all_data = async function (sl_type) {
                const pitts = await d3.json("pitts.geojson");
                console.log(pitts);
                // var counties = topojson.feature(pitts, pitts.features);
                // console.log(counties);
                var statesMesh = topojson.mesh(pitts, pitts.features);
                // const neightborhoods_mesh = topojson.mesh(sf,sf.objects.SFNeighborhoods);

                var projection = d3.geoMercator().fitSize([mapWidth, mapHeight], pitts);
                var path = d3.geoPath().projection(projection);

                let data = await d3.csv("yelp_pittsburgh.csv", d3.autoType);


                const request_map = async function (sl_type) {
                    console.log(clicked_cuisine)

                    let data_ready;
                    if (sl_type != "all") {
                        if (clicked_food == true){
                            if (clicked_cuisine == true || clicked_type == true){
                                let temp = data.filter(d => d.type === 'food');
                                data_ready = temp.filter(d => d.category === sl_type);
                            }else{
                                data_ready = data.filter(d => d.type === 'food');
                            }
                        }else{
                            data_ready = data.filter(d => d.type === sl_type);
                            

                        }

                    } else {
                        data_ready = data;
                        
                    }
                    console.log(data_ready);

                    // let compExtent = d3.extent(data, d => d.pay);
                    // let compScale = d3.scaleSequential(d3.interpolateViridis).domain(compExtent);
                    // let payScale = d3.scaleQuantile()
                    //     .domain(d3.extent(data, d => d.pay))
                    //     .range([d3.interpolateViridis(1), d3.interpolateViridis(0.7), d3.interpolateViridis(0.5), d3.interpolateViridis(0.3), d3.interpolateViridis(0.1)]);

                    map.selectAll("path.neighborhood").data(pitts.features)
                        .join("path")
                        .attr("class", "neighborhood")
                        .attr("d", path)
                    // .style('fill','white')

                    data.forEach(d => {
                        d.Position = projection([d.longitude, d.latitude]);
                    });

                    // let statesPath = map.selectAll("path.state")
                    //         .data(pitts.features)
                    //         .join(
                    //             enter => enter.append("path").attr("d", path)
                    //             .attr("class", "state")
                    //             .style("fill", d => payScale(
                    //                 stateIdCounts[d.id])).call(enter => enter.transition().attr("opacity", 1)),
                    //             update => update.call(update => update.transition().style("fill", d => payScale(
                    //                 stateIdCounts[d.id]))),
                    //             exit => exit.call(exit => exit.transition().attr('opacity', 0).remove())
                    //         );


                    // if (sl_type != "all"){
                    map.selectAll('image').remove();

                    map.selectAll("image")
                        .data(data_ready)
                        .join(
                            enter => enter.append('image').attr("xlink:href", d => {
                                let tp = d.type;
                                return tp + ".png";
                            })
                                .attr("x", d => d.Position[0])
                                .attr("y", d => d.Position[1])
                                .attr("width", 20)
                                .attr("height", 20)
                                .attr('class','icons')
                                .call(enter => enter.transition().attr("opacity", 1)),
                            // update => update.call(update => update.transition().style("opacity", d => {
                            //     console.log('update');
                            //     return 0;
                            // })),
                            // exit => exit.call(exit => exit.transition().attr("opacity", 0).remove())
                        );

                        console.log(d3.selectAll('.icons'))
                    


                    var zoom = d3.zoom()
                        .scaleExtent([1, 20])
                        .translateExtent([
                            [-50, -50],
                            [mapWidth + 50, mapHeight + 50]
                        ]) // to lock to edges
                        .on("zoom", mapZoomed);

                    svg.call(zoom);

                    svg.call(zoom.transform, d3.zoomIdentity); // Executes zoomed() once because we technically have changed the transform


                    function mapZoomed({
                        transform
                    }) { // Destructuring here directly pulls and assigns the transform
                        map.attr("transform", transform.toString());

                        map.selectAll("image").
                            attr('width', 20 / transform.k).
                            attr('height', 20 / transform.k);

                        data.forEach(d => {
                            d.Position = projection([d.longitude, d.latitude]);
                        });

                        data.filter(l => l.Position != null)

                    }

                    d3.selectAll(".icons").on("click", clicked_map);

                    function clicked_map (event, d) {

                        console.log(event);
        
                        requestData_table(event);

                    }

                }
                request_map(sl_type);

                // map.append("path")
                //     .datum(statesMesh)
                //     .attr("class", "street_outline")
                //     .attr('d',path)
                //     .style('stroke','grey')
                //     .style('stroke-width',"1px")
                //     .style('fill','none')


                function show_food(){
                    // if (button_already == true){
                    //     console.log(111);
                    // }
                    // clicked_food = true;
                    // button_already = true;
                    clicked_food = true;
                    let all_food_types = [];
                    data.forEach((item) => {
                        if (item.type == 'food' && !all_food_types.includes(item.category)){
                            all_food_types.push(item.category);
                        }
                    });

                    let cuisines = ['select','indpak','italian','newamerican','chinese','thai','mexican','french','japanese','vietnamese'];
                    let types_of_food = ['select','coffee','donuts','pizza','sandwiches','bakeries','cafes','sushi','ethnicmarkets'];

                    function add_cuisine_button(){
                        dropButton_cuisine = d3.select('.cuisine').append('select');
                        dropButton_cuisine.selectAll('options_').data(cuisines)
                                .enter()
                                .append('option')
                                .text(function(d){return d})
                                .attr('value',function(d){return d})

                    }
                    add_cuisine_button();

                    // let dropButton_type;
                    function add_type_button(){
                        dropButton_type = d3.select('.food_type').append('select');
                        dropButton_type.selectAll('options_').data(types_of_food)
                                .enter()
                                .append('option')
                                .text(function(d){return d})
                                .attr('value',function(d){return d})

                    }
                    add_type_button();
                    
                    
                    dropButton_cuisine.on('change', function(d){
                        let selected_category = d3.select(this).property("value");
                        
                        if (selected_category == 'select'){
                            clicked_cuisine = false;
                        }else{
                            clicked_cuisine = true;
                        }
                        if (clicked_cuisine){
                            dropButton_type.remove();
                        }else{
                            add_type_button();
                        }
                        request_map(selected_category);
                    })

                    

                    dropButton_type.on('change', function(d){

                        let selected_category = d3.select(this).property("value");
                        // clicked_food = true;
                        if (selected_category == 'select'){
                            clicked_type = false;
                        }else{
                            clicked_type = true;
                            // console.log(111);
                        }
                        if (clicked_type){
                            dropButton_cuisine.remove();
                        }else{
                            add_cuisine_button();
                        }
                        request_map(selected_category);
                    })



                }

                if (sl_type == "food" && clicked_food != true){
                    show_food();
                }
                

                

            }

            
            // map.selectAll(".icons").on("click", clicked_map);

            


            request_all_data("all");
            function remove_all_buttons(){
                if (clicked_food == true){
                    console.log(111);
                        if (clicked_cuisine == true || clicked_cuisine == false){
                                    dropButton_cuisine.remove();
                                // }
                                if (clicked_type == true || clicked_type == false){
                                    dropButton_type.remove();
                                }
                        }
                    }
                clicked_food = false;
            }

            d3.select("button#all").on("click", function (event) {
                let type = event.target.id;
                request_all_data("all");
                remove_all_buttons();
                
            });
            d3.select("button#arts").on("click", function (event) {
                let type = event.target.id;
                request_all_data(type);
                remove_all_buttons();
            });
            d3.select("button#shopping").on("click", function (event) {
                let type = event.target.id;
                request_all_data(type);
                remove_all_buttons();
            });
            d3.select("button#active").on("click", function (event) {
                let type = event.target.id;
                request_all_data(type);
                remove_all_buttons();
            });
            d3.select("button#food").on("click", function (event) {
                let type = event.target.id;
                request_all_data(type);
                remove_all_buttons();
            });
            d3.select("button#nightlife").on("click", function (event) {
                let type = event.target.id;
                request_all_data(type);
                remove_all_buttons();
            });
        </script>
    </div>


    <div class="right">

        <div id="table_title">
            <p id="table_title_content"></p>
        </div>

        <table id="table">
            <th id="thead"></th>
            <tr>
                <td id="rating">
                    <p id="this_rating"></p>
                </td>
            </tr>
            <tr>
                <td id="review_count">
                    <p id="this_review_count"></p>
                </td>
            </tr>
            <tr>
                <td id="neighborhood">
                    <p id="this_neighborhood"></p>
                </td>
            </tr>
            <tr>
                <td id="category">
                    <p id="this_category"></p>
                </td>
            </tr>
        </table>

        <script>
            const requestData_table = async function (e) {
                let data = await d3.csv("yelp_pittsburgh.csv", d3.autoType);


                console.log(e);
                let this_item = e.target.__data__.name;
                // let this_abbr = getKeyByValue(state_codes, this_state_code);
                // let this_state = getKeyByValue(us_state_to_abbrev, this_abbr);
                let table = d3.select('#table');
                // let data = await d3.csv("yelp_pittsburgh.csv", d3.autoType);
                data = data.filter(d => d.name === this_item);
                console.log( data);

                // initiate variables
                let table_data;
                let title;
                let rating = 0;
                let review_count = 0;
                let neighborhood = "";
                let category = "";

                title = this_item;
                rating = data[0].rating;
                review_count = data[0]["review count"];
                neighborhood = data[0].neighborhood;
                category = data[0].category;


                let text_title = d3.select("#table_title");
                text_title.select("#table_title_content").text(title);

                let text_rating = d3.select("#rating");
                text_rating.select("#this_rating").text("Rating:     " + rating);

                let text_review_count = d3.select("#review_count");
                text_review_count.select("#this_review_count").text("Number of Reviews:     " + review_count);

                let text_neighborhood = d3.select("#neighborhood");
                text_neighborhood.select("#this_neighborhood").text("Average Output:     " + neighborhood);

                let text_category = d3.select("#category");
                text_category.select("#this_category").text("Total category:     " + category);

            }
        
            // requestData_table(2007, "all");
                // requestData_table(""); -->
        </script>

    </div>


</body>

</html>